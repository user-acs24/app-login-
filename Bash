#!/bin/bash

TIMEOUT=5

grab_banner() {
    local host="$1"
    local port="$2"

    exec 3<>/dev/tcp/"$host"/"$port" || return 1

    # SSH banner
    if [[ "$port" -eq 22 ]]; then
        read -t $TIMEOUT banner <&3
        echo "$banner"
        exec 3<&-
        exec 3>&-
        return 0
    fi

    # HTTP banner
    if [[ "$port" -eq 80 || "$port" -eq 8080 ]]; then
        echo -e "GET / HTTP/1.1\r\nHost: $host\r\nConnection: close\r\n\r\n" >&3
        while read -r line <&3; do
            [[ -z "$line" ]] && break
            echo "$line"
        done
        exec 3<&-
        exec 3>&-
        return 0
    fi

    echo "No banner (protocol-specific)"
    exec 3<&-
    exec 3>&-
}

echo
echo -e "HOST\t\tPORT\tSTATUS\t\tBANNER"
echo "----------------------------------------------------------------------------------------------------"

while read -r line; do
    [[ -z "$line" || "$line" != *:* ]] && continue

    host="${line%%:*}"
    port="${line##*:}"

    timeout $TIMEOUT bash -c ">/dev/tcp/$host/$port" 2>/dev/null
    if [[ $? -eq 0 ]]; then
        banner=$(grab_banner "$host" "$port")
        [[ -z "$banner" ]] && banner="(no banner)"
        echo -e "$host\t$port\tOPEN\t\t$banner"
    else
        echo -e "$host\t$port\tCLOSED/FILTERED\t-"
    fi

done < targets.txt
