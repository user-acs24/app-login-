#!/bin/bash

echo
printf "%-20s %-6s %-15s %s\n" "HOST" "PORT" "STATUS" "BANNER"
echo "-------------------------------------------------------------------------------"

while read -r line; do
    [[ -z "$line" || "$line" != *:* ]] && continue

    host="${line%%:*}"
    port="${line##*:}"

    # PowerShell TCP connect + banner
    result=$(powershell -Command "
    try {
        \$client = New-Object System.Net.Sockets.TcpClient
        \$client.Connect('$host',$port)
        \$stream = \$client.GetStream()

        if ($port -eq 22) {
            \$reader = New-Object System.IO.StreamReader(\$stream)
            \$banner = \$reader.ReadLine()
            'OPEN|' + \$banner
        }
        elseif ($port -eq 80 -or $port -eq 8080) {
            \$writer = New-Object System.IO.StreamWriter(\$stream)
            \$writer.Write(\"GET / HTTP/1.1`r`nHost: $host`r`nConnection: close`r`n`r`n\")
            \$writer.Flush()
            \$reader = New-Object System.IO.StreamReader(\$stream)
            \$banner = \$reader.ReadLine()
            'OPEN|' + \$banner
        }
        else {
            'OPEN|No banner'
        }

        \$client.Close()
    }
    catch {
        'CLOSED|'
    }
    ")

    status="${result%%|*}"
    banner="${result#*|}"

    printf "%-20s %-6s %-15s %s\n" "$host" "$port" "$status" "$banner"

done < targets.txt
